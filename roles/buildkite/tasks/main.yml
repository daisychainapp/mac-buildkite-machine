---
# Buildkite role - configure Buildkite agents

- name: Set Homebrew prefix fact
  ansible.builtin.set_fact:
    homebrew_prefix: "{{ '/opt/homebrew' if ansible_facts['architecture'] == 'arm64' else '/usr/local' }}"

- name: Ensure Buildkite directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ homebrew_prefix }}/etc/buildkite-agent"
    - "{{ buildkite_hooks_path }}"
    - "{{ buildkite_builds_path }}"
    - "{{ buildkite_plugins_path }}"

- name: Deploy Buildkite agent configuration
  ansible.builtin.template:
    src: buildkite-agent.cfg.j2
    dest: "{{ homebrew_prefix }}/etc/buildkite-agent/buildkite-agent.cfg"
    mode: '0600'
  notify: restart buildkite agents

- name: Deploy environment hook
  ansible.builtin.template:
    src: hooks/environment.j2
    dest: "{{ buildkite_hooks_path }}/environment"
    mode: '0755'
  notify: restart buildkite agents

- name: Deploy pre-exit hook for cleanup
  ansible.builtin.template:
    src: hooks/pre-exit.j2
    dest: "{{ buildkite_hooks_path }}/pre-exit"
    mode: '0755'

# Clean up old custom LaunchAgent plists (if migrating from custom plist approach)
- name: Stop and remove old custom buildkite-agent plists
  ansible.builtin.shell: |
    for i in 1 2 3 4 5; do
      plist="{{ ansible_facts['env']['HOME'] }}/Library/LaunchAgents/com.buildkite.buildkite-agent-${i}.plist"
      if [ -f "$plist" ]; then
        launchctl bootout gui/$(id -u)/com.buildkite.buildkite-agent-${i} 2>/dev/null || true
        rm -f "$plist"
      fi
    done
  args:
    executable: /bin/bash
  changed_when: false

# Use brew services to manage the buildkite-agent
- name: Stop any existing brew buildkite-agent service
  ansible.builtin.command: brew services stop buildkite/buildkite/buildkite-agent
  register: brew_stop
  changed_when: "'Stopping' in brew_stop.stdout or brew_stop.rc == 0"
  failed_when: false

- name: Start buildkite-agent via brew services
  ansible.builtin.command: brew services start buildkite/buildkite/buildkite-agent
  register: brew_start
  changed_when: "'Successfully started' in brew_start.stdout"
  failed_when: false

- name: Wait for agent to start
  ansible.builtin.pause:
    seconds: 3

- name: Verify Buildkite agent is running
  ansible.builtin.command: pgrep -f buildkite-agent
  register: buildkite_running
  changed_when: false
  failed_when: false

- name: Display Buildkite agent status
  ansible.builtin.debug:
    msg: "Buildkite agent processes running: {{ buildkite_running.stdout_lines | length | default(0) }}"
