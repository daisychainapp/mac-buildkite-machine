---
# Secrets role - deploy build secrets to the machine

- name: Set Homebrew prefix fact
  ansible.builtin.set_fact:
    homebrew_prefix: "{{ '/opt/homebrew' if ansible_facts['architecture'] == 'arm64' else '/usr/local' }}"

- name: Ensure secrets directory exists
  ansible.builtin.file:
    path: "{{ homebrew_prefix }}/etc/buildkite-agent/secrets"
    state: directory
    mode: '0700'

# Deploy GitHub deploy key for ansible-pull
- name: Deploy GitHub deploy key
  ansible.builtin.copy:
    content: "{{ vault_github_deploy_key }}"
    dest: "{{ ansible_facts['env']['HOME'] }}/.ssh/mac-build-deploy"
    mode: '0600'
  when: vault_github_deploy_key is defined and vault_github_deploy_key | length > 0
  no_log: true

- name: Configure SSH to use deploy key for GitHub
  ansible.builtin.blockinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.ssh/config"
    create: true
    mode: '0600'
    marker: "# {mark} ANSIBLE MANAGED - mac-build deploy key"
    block: |
      Host github.com
        IdentityFile ~/.ssh/mac-build-deploy
        IdentitiesOnly yes

# Optional: Deploy additional secrets as environment files
# These can be sourced by Buildkite hooks

- name: Deploy build secrets environment file
  ansible.builtin.template:
    src: build-secrets.env.j2
    dest: "{{ homebrew_prefix }}/etc/buildkite-agent/secrets/build-secrets.env"
    mode: '0600'
  no_log: true

# Optional: AWS Secrets Manager integration
# Uncomment if you want to fetch secrets from AWS

# - name: Install boto3 for AWS lookups
#   ansible.builtin.pip:
#     name:
#       - boto3
#       - botocore
#     state: present
#
# - name: Fetch Buildkite token from AWS Secrets Manager
#   set_fact:
#     dynamic_buildkite_token: "{{ lookup('amazon.aws.aws_secret', 'buildkite/agent-token', region='us-east-1') }}"
#   when: use_aws_secrets_manager | default(false)
